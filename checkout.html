<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout – MediCart</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="header.css">

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#36C2CE',
                        'pharmacy-blue': '#2563eb',
                        'pharmacy-green': '#16a34a',
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .selected { @apply bg-blue-50 border-blue-500; }
        .border-dashed { @apply border-dashed; }
        .quantity-btn {
            @apply w-7 h-7 border rounded text-xs flex items-center justify-center transition;
        }
        .quantity-btn:hover {
            @apply bg-blue-500 text-white;
        }
        .remove-btn {
            @apply text-red-500 text-xs hover:underline;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">

<!-- Header Placeholder -->
<div id="header-placeholder"></div>

<div class="max-w-7xl mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-[1fr_380px] gap-8">
    <!-- Checkout Form -->
    <div class="bg-white rounded-xl p-6 md:p-8 border-2 border-primary shadow-lg">
        <form id="checkoutForm">
            <!-- Customer Information -->
            <section>
                <h2 class="text-2xl font-bold mb-5 pb-3 border-b-2 border-primary">Customer Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-6">
                    <div>
                        <label for="fullName" class="block font-medium text-gray-700 mb-2">Full Name *</label>
                        <input type="text" id="fullName" required class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition">
                    </div>
                    <div>
                        <label for="email" class="block font-medium text-gray-700 mb-2">Email *</label>
                        <input type="email" id="email" required class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label for="phone" class="block font-medium text-gray-700 mb-2">Phone Number *</label>
                        <input type="tel" id="phone" required class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition">
                    </div>
                    <div>
                        <label for="whatsapp" class="block font-medium text-gray-700 mb-2">WhatsApp (Optional)</label>
                        <input type="tel" id="whatsapp" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition">
                    </div>
                </div>
            </section>

            <!-- Shipping Address -->
            <section class="mt-10">
                <h2 class="text-2xl font-bold mb-5 pb-3 border-b-2 border-primary">Shipping Address</h2>
                <div id="addressList" class="space-y-3">
                    <!-- Default Address -->
                    <div class="p-4 bg-blue-50 border-2 border-blue-500 rounded-lg flex items-center justify-between selected">
                        <label class="flex items-center gap-3 cursor-pointer flex-1">
                            <input type="radio" name="selectedAddress" value="1" checked class="w-4 h-4 text-primary">
                            <span class="text-sm">
                                <strong>Home</strong><br>
                                123 MG Road, Pune, Maharashtra - 411001, India
                            </span>
                        </label>
                        <div class="flex gap-2">
                            <button type="button" class="w-8 h-8 bg-blue-600 text-white rounded-full text-xs flex items-center justify-center hover:bg-blue-700" onclick="editAddress(1)">Edit</button>
                            <button type="button" class="w-8 h-8 bg-red-600 text-white rounded-full text-xs flex items-center justify-center hover:bg-red-700" onclick="deleteAddress(1)">Delete</button>
                        </div>
                    </div>
                </div>

                <button type="button" class="mt-4 w-full p-3 border-2 border-dashed border-gray-300 text-gray-600 rounded-lg text-sm hover:border-primary hover:text-primary transition" onclick="showAddressForm()">
                    + Add New Address
                </button>

                <!-- New Address Form -->
                <div id="newAddressForm" class="hidden mt-5 p-5 bg-gray-50 rounded-lg border">
                    <input type="hidden" id="editAddressId">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="newAddress" placeholder="Street Address" class="p-3 border rounded-lg">
                        <input type="text" id="newCity" placeholder="City" class="p-3 border rounded-lg">
                        <input type="text" id="newState" placeholder="State" class="p-3 border rounded-lg">
                        <input type="text" id="newPincode" placeholder="Pincode" class="p-3 border rounded-lg">
                    </div>
                    <div class="mt-4">
                        <input type="text" id="newCountry" value="India" readonly class="p-3 border rounded-lg bg-gray-100">
                    </div>
                    <div class="mt-5 flex gap-3">
                        <button type="button" onclick="saveAddress()" class="bg-primary text-white px-5 py-2.5 rounded-lg font-medium hover:bg-[#2a9ba8]">Save</button>
                        <button type="button" onclick="hideAddressForm()" class="bg-gray-300 text-gray-700 px-5 py-2.5 rounded-lg font-medium hover:bg-gray-400">Cancel</button>
                    </div>
                </div>
            </section>

            <!-- Payment Method -->
            <section class="mt-10">
                <h2 class="text-2xl font-bold mb-5 pb-3 border-b-2 border-primary">Payment Method</h2>
                <div class="space-y-3">
                    <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="paymentMethod" value="creditCard" checked class="w-4 h-4 text-primary">
                        <span>Credit/Debit Card</span>
                    </label>
                    <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="paymentMethod" value="razorpay" class="w-4 h-4 text-primary">
                        <span>Razorpay</span>
                    </label>
                    <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="paymentMethod" value="cod" class="w-4 h-4 text-primary">
                        <span>Cash on Delivery (COD)</span>
                    </label>
                </div>

                <div id="cardDetails" class="mt-5 space-y-4">
                    <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19" class="w-full p-3 border rounded-lg">
                    <input type="text" id="nameOnCard" placeholder="Name on Card" class="w-full p-3 border rounded-lg">
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" id="expiryDate" placeholder="MM/YY" maxlength="5" class="p-3 border rounded-lg">
                        <input type="text" id="cvv" placeholder="CVV" maxlength="3" class="p-3 border rounded-lg">
                    </div>
                </div>
            </section>
        </form>
    </div>

    <!-- Order Summary -->
    <div class="bg-white rounded-xl p-6 md:p-8 border-2 border-primary shadow-lg h-fit sticky top-6">
        <h2 class="text-2xl font-bold mb-5 pb-3 border-b-2 border-primary">Order Summary</h2>
        <div id="orderItems" class="space-y-4 max-h-96 overflow-y-auto"></div>

        <div class="mt-6 flex gap-2">
            <input type="text" id="couponCode" placeholder="Enter coupon code" class="flex-1 p-3 border rounded-lg text-sm">
            <button onclick="applyCoupon()" class="bg-primary text-white px-4 py-3 rounded-lg text-sm font-medium hover:bg-[#2a9ba8]">Apply</button>
        </div>

        <div class="mt-6 pt-4 border-t space-y-2">
            <div class="flex justify-between text-gray-600"><span>Subtotal</span><span id="subtotal">₹0.00</span></div>
            <div class="flex justify-between text-gray-600"><span>Shipping</span><span id="shipping">₹0.00</span></div>
            <div class="flex justify-between text-gray-600"><span>Tax (5%)</span><span id="tax">₹0.00</span></div>
            <div class="flex justify-between text-pharmacy-green hidden" id="discountRow"><span>Discount</span><span id="discount">-₹0.00</span></div>
            <div class="flex justify-between font-bold text-lg pt-3 border-t"><span>Total</span><span id="total" class="text-primary">₹0.00</span></div>
        </div>

        <button onclick="placeOrder()" class="w-full mt-6 bg-primary text-white py-4 rounded-lg font-bold text-lg hover:bg-[#2a9ba8] transition flex items-center justify-center gap-2">
            <i class="fas fa-lock"></i> Place Order
        </button>

        <div class="mt-6 text-center text-xs text-gray-500 space-y-1">
            <a href="#" onclick="showPolicy('privacy')" class="hover:underline">Privacy Policy</a> • 
            <a href="#" onclick="showPolicy('cancellation')" class="hover:underline">Cancellation</a> • 
            <a href="#" onclick="showPolicy('shipping')" class="hover:underline">Shipping</a>
        </div>

        <div class="flex justify-center gap-3 mt-5">
            <div class="w-10 h-6 bg-[#1a1f71] text-white rounded flex items-center justify-center text-xs font-bold">VISA</div>
            <div class="w-10 h-6 bg-[#eb001b] text-white rounded flex items-center justify-center text-xs font-bold">MC</div>
            <div class="w-10 h-6 bg-[#003087] text-white rounded flex items-center justify-center text-xs font-bold">PayPal</div>
            <div class="w-10 h-6 bg-[#528ff0] text-white rounded flex items-center justify-center text-xs font-bold">Razor</div>
        </div>
    </div>
</div>

<!-- ====================== SCRIPTS ====================== -->
<script>
    // Load cart
    let cart = JSON.parse(localStorage.getItem('cart')) || [];

    // Load sample cart if empty (for testing)
    if (cart.length === 0) {
        cart = [
            { id: 1, name: 'Paracetamol 500mg', price: 49, image: 'https://i.pinimg.com/1200x/df/3b/b2/df3bb27c00bb0f4b54692f9000a56b1f.jpg', variant: 'Default', quantity: 2, prescriptionRequired: true },
            { id: 2, name: 'Whisper Ultra Wings', price: 279, image: 'https://i.pinimg.com/736x/15/b9/8d/15b98d803f2e10178711489c46061497.jpg', variant: 'XL', quantity: 1 }
        ];
        localStorage.setItem('cart', JSON.stringify(cart));
    }

    let addressCounter = 1;

    // Load order items
    function loadOrderItems() {
        const container = document.getElementById('orderItems');
        if (cart.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-500 py-8">Your cart is empty</p>';
            return;
        }

        container.innerHTML = cart.map(item => `
            <div class="flex items-center gap-4 py-3 border-b">
                <img src="${item.image}" alt="${item.name}" class="w-14 h-14 rounded object-cover">
                <div class="flex-1">
                    <div class="font-medium text-sm">${item.name}</div>
                    ${item.variant && item.variant !== 'Default' ? `<div class="text-xs text-gray-500">Size: ${item.variant}</div>` : ''}
                    ${item.prescriptionRequired ? `<div class="text-xs text-red-600 font-medium">Prescription Required</div>` : ''}
                </div>
                <div class="text-right">
                    <div class="font-semibold">₹${(item.price * item.quantity).toFixed(2)}</div>
                    <div class="flex items-center gap-1 mt-1">
                        <button onclick="updateQty(${item.id}, '${item.variant}', -1)" class="quantity-btn">-</button>
                        <span class="w-6 text-center text-sm">${item.quantity}</span>
                        <button onclick="updateQty(${item.id}, '${item.variant}', 1)" class="quantity-btn">+</button>
                    </div>
                    <button onclick="removeItem(${item.id}, '${item.variant}')" class="remove-btn mt-1 block">Remove</button>
                </div>
            </div>
        `).join('');
        updateTotals();
    }

    function updateQty(id, variant, change) {
        const item = cart.find(i => i.id === id && i.variant === variant);
        if (item) {
            item.quantity = Math.max(1, item.quantity + change);
            localStorage.setItem('cart', JSON.stringify(cart));
            loadOrderItems();
        }
    }

    function removeItem(id, variant) {
        cart = cart.filter(i => !(i.id === id && i.variant === variant));
        localStorage.setItem('cart', JSON.stringify(cart));
        loadOrderItems();
    }

    function updateTotals() {
        const subtotal = cart.reduce((s, i) => s + i.price * i.quantity, 0);
        const shipping = subtotal > 500 ? 0 : 49;
        const tax = subtotal * 0.05;
        const discount = parseFloat(localStorage.getItem('appliedDiscount') || '0');
        const total = subtotal + shipping + tax - discount;

        document.getElementById('subtotal').textContent = `₹${subtotal.toFixed(2)}`;
        document.getElementById('shipping').textContent = `₹${shipping.toFixed(2)}`;
        document.getElementById('tax').textContent = `₹${tax.toFixed(2)}`;
        document.getElementById('total').textContent = `₹${total.toFixed(2)}`;

        const discountRow = document.getElementById('discountRow');
        const discountEl = document.getElementById('discount');
        if (discount > 0) {
            discountEl.textContent = `-₹${discount.toFixed(2)}`;
            discountRow.classList.remove('hidden');
        } else {
            discountRow.classList.add('hidden');
        }
    }

    function applyCoupon() {
        const code = document.getElementById('couponCode').value.trim().toUpperCase();
        const coupons = { 'MEDI10': 50, 'SAVE20': 100, 'HEALTH25': 75 };
        if (coupons[code]) {
            localStorage.setItem('appliedDiscount', coupons[code]);
            updateTotals();
            alert(`Coupon ${code} applied! Saved ₹${coupons[code]}`);
            document.getElementById('couponCode').value = '';
        } else {
            alert('Invalid coupon code');
        }
    }

    // Address Functions
    function showAddressForm() {
        document.getElementById('newAddressForm').classList.remove('hidden');
        document.getElementById('editAddressId').value = '';
        clearAddressForm();
    }

    function hideAddressForm() {
        document.getElementById('newAddressForm').classList.add('hidden');
    }

    function clearAddressForm() {
        ['newAddress', 'newCity', 'newState', 'newPincode'].forEach(id => document.getElementById(id).value = '');
        document.getElementById('newCountry').value = 'India';
    }

    function saveAddress() {
        const fields = ['newAddress', 'newCity', 'newState', 'newPincode'];
        const values = fields.map(id => document.getElementById(id).value.trim());
        if (values.some(v => !v)) return alert('Please fill all address fields');

        const [addr, city, state, pin] = values;
        const full = `${addr}, ${city}, ${state} - ${pin}`;
        const id = document.getElementById('editAddressId').value || ++addressCounter;

        if (document.getElementById('editAddressId').value) {
            const input = document.querySelector(`input[value="${id}"]`);
            const label = input.closest('label').querySelector('span');
            label.innerHTML = `<strong>Address ${id}</strong><br>${full}`;
            ['address', 'city', 'state', 'pincode'].forEach((k, i) => input.dataset[k] = values[i]);
        } else {
            const html = `
                <div class="p-4 bg-gray-50 border rounded-lg flex items-center justify-between hover:bg-blue-50 transition">
                    <label class="flex items-center gap-3 cursor-pointer flex-1">
                        <input type="radio" name="selectedAddress" value="${id}" class="w-4 h-4 text-primary"
                               data-address="${addr}" data-city="${city}" data-state="${state}" data-pincode="${pin}" data-country="India">
                        <span class="text-sm"><strong>Address ${id}</strong><br>${full}</span>
                    </label>
                    <div class="flex gap-2">
                        <button type="button" class="w-8 h-8 bg-blue-600 text-white rounded-full text-xs flex items-center justify-center hover:bg-blue-700" onclick="editAddress(${id})">Edit</button>
                        <button type="button" class="w-8 h-8 bg-red-600 text-white rounded-full text-xs flex items-center justify-center hover:bg-red-700" onclick="deleteAddress(${id})">Delete</button>
                    </div>
                </div>`;
            document.getElementById('addressList').insertAdjacentHTML('beforeend', html);
        }
        hideAddressForm();
    }

    function editAddress(id) {
        const input = document.querySelector(`input[value="${id}"]`);
        document.getElementById('editAddressId').value = id;
        document.getElementById('newAddress').value = input.dataset.address;
        document.getElementById('newCity').value = input.dataset.city;
        document.getElementById('newState').value = input.dataset.state;
        document.getElementById('newPincode').value = input.dataset.pincode;
        showAddressForm();
    }

    function deleteAddress(id) {
        if (document.querySelectorAll('#addressList input').length <= 1) {
            return alert('You must have at least one address');
        }
        document.querySelector(`input[value="${id}"]`).closest('div').remove();
    }

    // Payment toggle
    document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
        radio.addEventListener('change', () => {
            document.getElementById('cardDetails').style.display = radio.value === 'creditCard' ? 'block' : 'none';
        });
    });

    function showPolicy(type) {
        const policies = {
            privacy: "We respect your privacy. Your data is safe and never shared.",
            cancellation: "Cancel within 24 hours for full refund.",
            shipping: "Free shipping on orders above ₹500. Delivery in 2–5 days."
        };
        alert(policies[type]);
    }

    // PLACE ORDER – CLEARS CART COMPLETELY
    function placeOrder() {
        if (cart.length === 0) return alert('Your cart is empty!');

        const selectedAddress = document.querySelector('input[name="selectedAddress"]:checked');
        if (!selectedAddress) return alert('Please select a shipping address');

        const form = document.getElementById('checkoutForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const subtotal = cart.reduce((s, i) => s + i.price * i.quantity, 0);
        const shipping = subtotal > 500 ? 0 : 49;
        const tax = subtotal * 0.05;
        const discount = parseFloat(localStorage.getItem('appliedDiscount') || '0');
        const total = subtotal + shipping + tax - discount;

        const order = {
            id: Date.now(),
            date: new Date().toLocaleDateString('en-IN'),
            items: cart.map(i => ({
                name: i.name,
                image: i.image,
                variant: i.variant || 'Default',
                quantity: i.quantity,
                price: i.price,
                total: i.price * i.quantity
            })),
            customer: {
                name: document.getElementById('fullName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value
            },
            address: selectedAddress.nextElementSibling.textContent.trim(),
            payment: document.querySelector('input[name="paymentMethod"]:checked').parentElement.textContent.trim(),
            subtotal, shipping, tax, discount, total,
            status: 'Confirmed'
        };

        // Save order
        const orders = JSON.parse(localStorage.getItem('medicart_orders') || '[]');
        orders.unshift(order);
        localStorage.setItem('medicart_orders', JSON.stringify(orders));

        // === EMPTY THE CART ===
        localStorage.removeItem('cart');           // Remove all cart items
        localStorage.removeItem('appliedDiscount'); // Remove coupon
        localStorage.setItem('cartCount', '0');    // Reset cart badge

        alert('Order placed successfully! Your cart is now empty.');
        window.location.href = 'my-orders.html';
    }

    // Card formatting
    document.getElementById('cardNumber').addEventListener('input', e => {
        let v = e.target.value.replace(/\D/g, '').slice(0, 16);
        e.target.value = v.match(/.{1,4}/g)?.join(' ') || v;
    });
    document.getElementById('expiryDate').addEventListener('input', e => {
        let v = e.target.value.replace(/\D/g, '').slice(0, 4);
        if (v.length >= 2) v = v.slice(0,2) + '/' + v.slice(2);
        e.target.value = v;
    });
    document.getElementById('cvv').addEventListener('input', e => {
        e.target.value = e.target.value.replace(/\D/g, '').slice(0,3);
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        loadOrderItems();

        // Load header
        fetch('/header.html')
            .then(r => r.text())
            .then(html => {
                document.getElementById('header-placeholder').innerHTML = html;
                if (typeof initializePage === 'function') initializePage();
            })
            .catch(() => {});
    });
</script>

</body>
</html>