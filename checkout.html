<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout – MediCart</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="header.css">

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#36C2CE',
                        'pharmacy-blue': '#2563eb',
                        'pharmacy-green': '#16a34a',
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .selected { @apply bg-blue-50 border-blue-500; }
        .border-dashed { @apply border-dashed; }
        .quantity-btn {
            @apply w-7 h-7 border rounded text-xs flex items-center justify-center transition;
        }
        .quantity-btn:hover {
            @apply bg-blue-500 text-white;
        }
        .remove-btn {
            @apply text-red-500 text-xs hover:underline;
        }
        
        /* Success Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            max-width: 450px;
            width: 90%;
            text-align: center;
            animation: slideUp 0.4s ease;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(30px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .success-checkmark {
            width: 80px;
            height: 80px;
            margin: 0 auto 1.5rem;
            border-radius: 50%;
            background: #16a34a;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: scaleIn 0.5s ease 0.2s both;
        }
        
        @keyframes scaleIn {
            from { 
                transform: scale(0);
            }
            to { 
                transform: scale(1);
            }
        }
        
        .success-checkmark i {
            color: white;
            font-size: 2.5rem;
            animation: checkPop 0.3s ease 0.5s both;
        }
        
        @keyframes checkPop {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
<!-- Back Arrow Button -->
<div class="max-w-7xl mx-auto px-4 py-4">
    <button onclick="history.back()" class="flex items-center gap-2 text-gray-700 hover:text-primary transition">
        <i class="fas fa-arrow-left text-lg"></i>
        <span class="font-medium">Back</span>
    </button>
</div>
<!-- Header Placeholder -->
<div id="header-placeholder"></div>

<div class="max-w-7xl mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-[1fr_380px] gap-8">
    <!-- Checkout Form -->
    <div class="bg-white rounded-xl p-6 md:p-8 border-2 border-primary shadow-lg">
        <form id="checkoutForm">
            <!-- Customer Information -->
            <section>
                <h2 class="text-2xl font-bold mb-5 pb-3 border-b-2 border-primary">Customer Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-6">
                    <div>
                        <label for="fullName" class="block font-medium text-gray-700 mb-2">Full Name *</label>
                        <input type="text" id="fullName" required class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition">
                    </div>
                    <div>
                        <label for="email" class="block font-medium text-gray-700 mb-2">Email *</label>
                        <input type="email" id="email" required class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label for="phone" class="block font-medium text-gray-700 mb-2">Phone Number *</label>
                        <input type="tel" id="phone" required class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition">
                    </div>
                    <div>
                        <label for="whatsapp" class="block font-medium text-gray-700 mb-2">WhatsApp (Optional)</label>
                        <input type="tel" id="whatsapp" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition">
                    </div>
                </div>
            </section>

            <!-- Shipping Address -->
            <section class="mt-10">
                <h2 class="text-2xl font-bold mb-5 pb-3 border-b-2 border-primary">Shipping Address</h2>
                <div id="addressList" class="space-y-3">
                    <!-- Default Address -->
                    <div class="p-4 bg-blue-50 border-2 border-blue-500 rounded-lg flex items-center justify-between selected">
                        <label class="flex items-center gap-3 cursor-pointer flex-1">
                            <input type="radio" name="selectedAddress" value="1" checked class="w-4 h-4 text-primary"
                                   data-address="123 MG Road" data-city="Pune" data-state="Maharashtra" data-pincode="411001">
                            <span class="text-sm">
                                <strong>Home</strong><br>
                                123 MG Road, Pune, Maharashtra - 411001, India
                            </span>
                        </label>
                        <div class="flex gap-2">
                            <button type="button" class="w-8 h-8 bg-blue-600 text-white rounded-full text-xs flex items-center justify-center hover:bg-blue-700" onclick="editAddress(1)">Edit</button>
                            <button type="button" class="w-8 h-8 bg-red-600 text-white rounded-full text-xs flex items-center justify-center hover:bg-red-700" onclick="deleteAddress(1)">Delete</button>
                        </div>
                    </div>
                </div>

                <button type="button" class="mt-4 w-full p-3 border-2 border-dashed border-gray-300 text-gray-600 rounded-lg text-sm hover:border-primary hover:text-primary transition" onclick="showAddressForm()">
                    + Add New Address
                </button>

                <!-- Address Form -->
                <div id="newAddressForm" class="hidden mt-5 p-5 bg-gray-50 rounded-lg border">
                    <input type="hidden" id="editAddressId">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="newAddress" placeholder="Street Address" class="p-3 border rounded-lg">
                        <input type="text" id="newCity" placeholder="City" class="p-3 border rounded-lg">
                        <input type="text" id="newState" placeholder="State" class="p-3 border rounded-lg">
                        <input type="text" id="newPincode" placeholder="Pincode" class="p-3 border rounded-lg">
                    </div>
                    <div class="mt-4">
                        <input type="text" id="newCountry" value="India" readonly class="p-3 border rounded-lg bg-gray-100">
                    </div>
                    <div class="mt-5 flex gap-3">
                        <button type="button" onclick="saveAddress()" class="bg-primary text-white px-5 py-2.5 rounded-lg font-medium hover:bg-[#2a9ba8]">Save</button>
                        <button type="button" onclick="hideAddressForm()" class="bg-gray-300 text-gray-700 px-5 py-2.5 rounded-lg font-medium hover:bg-gray-400">Cancel</button>
                    </div>
                </div>
            </section>

            <!-- Payment Method -->
            <section class="mt-10">
                <h2 class="text-2xl font-bold mb-5 pb-3 border-b-2 border-primary">Payment Method</h2>
                <div class="space-y-3">
                    <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="paymentMethod" value="creditCard" checked class="w-4 h-4 text-primary">
                        <span>Credit/Debit Card</span>
                    </label>
                    <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="paymentMethod" value="razorpay" class="w-4 h-4 text-primary">
                        <span>Razorpay</span>
                    </label>
                    <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="paymentMethod" value="cod" class="w-4 h-4 text-primary">
                        <span>Cash on Delivery (COD)</span>
                    </label>
                </div>

                <div id="cardDetails" class="mt-5 space-y-4">
                    <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19" class="w-full p-3 border rounded-lg">
                    <input type="text" id="nameOnCard" placeholder="Name on Card" class="w-full p-3 border rounded-lg">
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" id="expiryDate" placeholder="MM/YY" maxlength="5" class="p-3 border rounded-lg">
                        <input type="text" id="cvv" placeholder="CVV" maxlength="3" class="p-3 border rounded-lg">
                    </div>
                </div>
            </section>
        </form>
    </div>

    <!-- Order Summary -->
    <div class="bg-white rounded-xl p-6 md:p-8 border-2 border-primary shadow-lg h-fit sticky top-6">
        <h2 class="text-2xl font-bold mb-5 pb-3 border-b-2 border-primary">Order Summary</h2>
        <div id="orderItems" class="space-y-4 max-h-96 overflow-y-auto"></div>

        <div class="mt-6 flex gap-2">
            <input type="text" id="couponCode" placeholder="Enter coupon code" class="flex-1 p-3 border rounded-lg text-sm">
            <button onclick="applyCoupon()" class="bg-primary text-white px-4 py-3 rounded-lg text-sm font-medium hover:bg-[#2a9ba8]">Apply</button>
        </div>

        <div class="mt-6 pt-4 border-t space-y-2">
            <div class="flex justify-between text-gray-600"><span>Subtotal</span><span id="subtotal">₹0.00</span></div>
            <div class="flex justify-between text-gray-600"><span>Shipping</span><span id="shipping">₹0.00</span></div>
            <div class="flex justify-between text-gray-600"><span>Tax (5%)</span><span id="tax">₹0.00</span></div>
            <div class="flex justify-between text-pharmacy-green hidden" id="discountRow"><span>Discount</span><span id="discount">-₹0.00</span></div>
            <div class="flex justify-between font-bold text-lg pt-3 border-t"><span>Total</span><span id="total" class="text-primary">₹0.00</span></div>
        </div>

        <button onclick="placeOrder()" class="w-full mt-6 bg-primary text-white py-4 rounded-lg font-bold text-lg hover:bg-[#2a9ba8] transition flex items-center justify-center gap-2">
            <i class="fas fa-lock"></i> Place Order
        </button>
    </div>
</div>

<!-- Success Modal -->
<div id="successModal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="success-checkmark">
            <i class="fas fa-check"></i>
        </div>
        <h2 class="text-3xl font-bold text-gray-900 mb-3">Order Placed Successfully!</h2>
        <p class="text-gray-600 mb-6">Thank you for your order. We'll send you a confirmation email shortly.</p>
        <div class="space-y-3">
            <button onclick="viewMyOrders()" class="w-full bg-primary text-white py-3 rounded-lg font-semibold hover:bg-[#2a9ba8] transition">
                <i class="fas fa-box-open mr-2"></i>View My Orders
            </button>
            <button onclick="continueShopping()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition">
                Continue Shopping
            </button>
        </div>
    </div>
</div>

<script>
    // Cart
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    if (cart.length === 0) {
        cart = [
            { id: 1, name: 'Paracetamol 500mg', price: 49, image: 'https://i.pinimg.com/1200x/df/3b/b2/df3bb27c00bb0f4b54692f9000a56b1f.jpg', variant: 'Default', quantity: 2, prescriptionRequired: true },
            { id: 2, name: 'Whisper Ultra Wings', price: 279, image: 'https://i.pinimg.com/736x/15/b9/8d/15b98d803f2e10178711489c46061497.jpg', variant: 'XL', quantity: 1 }
        ];
        localStorage.setItem('cart', JSON.stringify(cart));
    }

    let addressCounter = 1;

    // Load Items
    function loadOrderItems() {
        const container = document.getElementById('orderItems');
        if (cart.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-500 py-8">Your cart is empty</p>';
            return;
        }
        container.innerHTML = cart.map(item => `
            <div class="flex items-center gap-4 py-3 border-b">
                <img src="${item.image}" alt="${item.name}" class="w-14 h-14 rounded object-cover">
                <div class="flex-1">
                    <div class="font-medium text-sm">${item.name}</div>
                    ${item.variant && item.variant !== 'Default' ? `<div class="text-xs text-gray-500">Size: ${item.variant}</div>` : ''}
                    ${item.prescriptionRequired ? `<div class="text-xs text-red-600 font-medium">Prescription Required</div>` : ''}
                </div>
                <div class="text-right">
                    <div class="font-semibold">₹${(item.price * item.quantity).toFixed(2)}</div>
                    <div class="flex items-center gap-1 mt-1">
                        <button onclick="updateQty(${item.id}, '${item.variant}', -1)" class="quantity-btn">-</button>
                        <span class="w-6 text-center text-sm">${item.quantity}</span>
                        <button onclick="updateQty(${item.id}, '${item.variant}', 1)" class="quantity-btn">+</button>
                    </div>
                    <button onclick="removeItem(${item.id}, '${item.variant}')" class="remove-btn mt-1 block">Remove</button>
                </div>
            </div>
        `).join('');
        updateTotals();
    }

    function updateQty(id, variant, change) {
        const item = cart.find(i => i.id === id && i.variant === variant);
        if (item) {
            item.quantity = Math.max(1, item.quantity + change);
            localStorage.setItem('cart', JSON.stringify(cart));
            loadOrderItems();
        }
    }

    function removeItem(id, variant) {
        cart = cart.filter(i => !(i.id === id && i.variant === variant));
        localStorage.setItem('cart', JSON.stringify(cart));
        loadOrderItems();
    }

    function updateTotals() {
        const subtotal = cart.reduce((s, i) => s + i.price * i.quantity, 0);
        const shipping = subtotal > 500 ? 0 : 49;
        const tax = subtotal * 0.05;
        const discount = parseFloat(localStorage.getItem('appliedDiscount') || '0');
        const total = subtotal + shipping + tax - discount;

        document.getElementById('subtotal').textContent = `₹${subtotal.toFixed(2)}`;
        document.getElementById('shipping').textContent = `₹${shipping.toFixed(2)}`;
        document.getElementById('tax').textContent = `₹${tax.toFixed(2)}`;
        document.getElementById('total').textContent = `₹${total.toFixed(2)}`;

        const discountRow = document.getElementById('discountRow');
        const discountEl = document.getElementById('discount');
        if (discount > 0) {
            discountEl.textContent = `-₹${discount.toFixed(2)}`;
            discountRow.classList.remove('hidden');
        } else {
            discountRow.classList.add('hidden');
        }
    }

    function applyCoupon() {
        const code = document.getElementById('couponCode').value.trim().toUpperCase();
        const coupons = { 'MEDI10': 50, 'SAVE20': 100, 'HEALTH25': 75 };
        if (coupons[code]) {
            localStorage.setItem('appliedDiscount', coupons[code]);
            updateTotals();
            alert(`Coupon ${code} applied! Saved ₹${coupons[code]}`);
            document.getElementById('couponCode').value = '';
        } else {
            alert('Invalid coupon code');
        }
    }

    // === ADDRESS FUNCTIONS ===
    function showAddressForm() {
        document.getElementById('newAddressForm').classList.remove('hidden');
        document.getElementById('editAddressId').value = '';
        clearAddressForm();
    }

    function hideAddressForm() {
        document.getElementById('newAddressForm').classList.add('hidden');
    }

    function clearAddressForm() {
        document.getElementById('newAddress').value = '';
        document.getElementById('newCity').value = '';
        document.getElementById('newState').value = '';
        document.getElementById('newPincode').value = '';
        document.getElementById('newCountry').value = 'India';
    }

    function editAddress(id) {
        const input = document.querySelector(`input[value="${id}"]`);
        if (!input) return;

        document.getElementById('editAddressId').value = id;
        document.getElementById('newAddress').value = input.dataset.address || '';
        document.getElementById('newCity').value = input.dataset.city || '';
        document.getElementById('newState').value = input.dataset.state || '';
        document.getElementById('newPincode').value = input.dataset.pincode || '';
        document.getElementById('newAddressForm').classList.remove('hidden');
    }

    function saveAddress() {
        const addr = document.getElementById('newAddress').value.trim();
        const city = document.getElementById('newCity').value.trim();
        const state = document.getElementById('newState').value.trim();
        const pin = document.getElementById('newPincode').value.trim();

        if (!addr || !city || !state || !pin) {
            return alert('Please fill all fields');
        }

        const full = `${addr}, ${city}, ${state} - ${pin}`;
        const editId = document.getElementById('editAddressId').value;

        if (editId) {
            // EDIT EXISTING
            const input = document.querySelector(`input[value="${editId}"]`);
            const span = input.parentElement.querySelector('span');
            span.innerHTML = `<strong>Address ${editId}</strong><br>${full}`;
            input.dataset.address = addr;
            input.dataset.city = city;
            input.dataset.state = state;
            input.dataset.pincode = pin;
        } else {
            // ADD NEW
            addressCounter++;
            const html = `
                <div class="p-4 bg-gray-50 border rounded-lg flex items-center justify-between hover:bg-blue-50 transition">
                    <label class="flex items-center gap-3 cursor-pointer flex-1">
                        <input type="radio" name="selectedAddress" value="${addressCounter}" class="w-4 h-4 text-primary"
                               data-address="${addr}" data-city="${city}" data-state="${state}" data-pincode="${pin}">
                        <span class="text-sm"><strong>Address ${addressCounter}</strong><br>${full}</span>
                    </label>
                    <div class="flex gap-2">
                        <button type="button" class="w-8 h-8 bg-blue-600 text-white rounded-full text-xs flex items-center justify-center hover:bg-blue-700" onclick="editAddress(${addressCounter})">Edit</button>
                        <button type="button" class="w-8 h-8 bg-red-600 text-white rounded-full text-xs flex items-center justify-center hover:bg-red-700" onclick="deleteAddress(${addressCounter})">Delete</button>
                    </div>
                </div>`;
            document.getElementById('addressList').insertAdjacentHTML('beforeend', html);
        }
        hideAddressForm();
    }

    function deleteAddress(id) {
        if (document.querySelectorAll('#addressList > div').length <= 1) {
            return alert('You must have at least one address');
        }
        document.querySelector(`input[value="${id}"]`).closest('div').remove();
    }

    // Payment toggle
    document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
        radio.addEventListener('change', () => {
            document.getElementById('cardDetails').style.display = radio.value === 'creditCard' ? 'block' : 'none';
        });
    });

    function placeOrder() {
        if (cart.length === 0) return alert('Cart is empty');
        const addr = document.querySelector('input[name="selectedAddress"]:checked');
        if (!addr) return alert('Select address');
        if (!document.getElementById('checkoutForm').checkValidity()) {
            document.getElementById('checkoutForm').reportValidity();
            return;
        }

        // Clear cart and discount
        localStorage.removeItem('cart');
        localStorage.removeItem('appliedDiscount');
        
        // Show success modal
        document.getElementById('successModal').classList.remove('hidden');
        
        // Trigger confetti cannons
        triggerConfetti();
    }
    
    function triggerConfetti() {
        const end = Date.now() + 3 * 1000; // 3 seconds
        const colors = ["#36C2CE", "#a786ff", "#fd8bbc", "#eca184", "#f8deb1"];
        
        (function frame() {
            if (Date.now() > end) return;
            
            // Left cannon
            confetti({
                particleCount: 2,
                angle: 60,
                spread: 55,
                startVelocity: 60,
                origin: { x: 0, y: 0.5 },
                colors: colors,
            });
            
            // Right cannon
            confetti({
                particleCount: 2,
                angle: 120,
                spread: 55,
                startVelocity: 60,
                origin: { x: 1, y: 0.5 },
                colors: colors,
            });
            
            requestAnimationFrame(frame);
        })();
    }
    
    function viewMyOrders() {
        window.location.href = '/MY ORDERS/myorders.html';
    }
    
    function continueShopping() {
        window.location.href = 'index.html';
    }

    // Init
    document.addEventListener('DOMContentLoaded', loadOrderItems);
</script>

</body>
</html>